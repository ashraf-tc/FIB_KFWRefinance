package com.ce.ratechange.batch;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

import com.misys.cbs.common.util.log.CBSLogger;
import com.misys.fbe.common.util.CommonUtil;
import com.trapedza.bankfusion.batch.fatom.AbstractPersistableFatomContext;
import com.trapedza.bankfusion.batch.process.AbstractBatchProcess;
import com.trapedza.bankfusion.batch.process.AbstractProcessAccumulator;
import com.trapedza.bankfusion.bo.refimpl.IBOBT_UDF_ACCTFR;
import com.trapedza.bankfusion.bo.refimpl.IBOCE_LEN_KfwRefinanceRateHistory;
import com.trapedza.bankfusion.bo.refimpl.IBOCE_LEN_RefinanceRateChangeTag;
import com.trapedza.bankfusion.bo.refimpl.IBOCreditInterestFeature;
import com.trapedza.bankfusion.bo.refimpl.IBOUB_ACC_AccountTaxDues;
import com.trapedza.bankfusion.bo.refimpl.IBOUDFBOScreenAssociation;
import com.trapedza.bankfusion.bo.refimpl.IBOUDFEXTAttributeCollectionFeature;
import com.trapedza.bankfusion.persistence.core.IPersistenceObjectsFactory;
import com.trapedza.bankfusion.servercommon.commands.BankFusionEnvironment;
import com.trapedza.bankfusion.servercommon.core.BankFusionThreadLocal;

import bf.com.misys.bankfusion.attributes.UserDefinedFields;
import bf.com.misys.bankfusion.attributes.UserDefinedFld;

public class RefinanceRateChangeProcess extends AbstractBatchProcess {
	private static final String UDF_INTERPOLATEDRATE = "UDF_INTERPOLATEDRATE";
	private BankFusionEnvironment env;
	IPersistenceObjectsFactory factory;
	private RefinanceRateChangeAccumulator accumulator;
	private RefinanceRateChangeContext context;

	private CBSLogger LOGGER = new CBSLogger(RefinanceRateChangeProcess.class.getName());

	public RefinanceRateChangeProcess(AbstractPersistableFatomContext context) {
		super(context);
		this.env = BankFusionThreadLocal.getBankFusionEnvironment();
		this.context = (RefinanceRateChangeContext) context;
	}

	@Override
	public AbstractProcessAccumulator getAccumulator() {
		return accumulator;
	}

	@Override
	public void init() {
		initialiseAccumulator();
	}

	@Override
	protected void initialiseAccumulator() {
		Object[] acc = new Object[0];
		accumulator = new RefinanceRateChangeAccumulator(acc);

	}

	@SuppressWarnings({ "unchecked", "deprecation", "rawtypes" })
	@Override
	public AbstractProcessAccumulator process(int pageToProcess) {
		LOGGER.info("process()", "Testbatchprocess started");
		this.context = (RefinanceRateChangeContext) context;
		pagingData.setCurrentPageNumber(pageToProcess);
		
		int pageSize = this.context.getPageSize();
		int fromValue = ((pageToProcess - 1) * pageSize) + 1;
		int toValue = (pageToProcess * pageSize);
		LOGGER.info("Process", "\n" + fromValue + " ----- " + toValue);
		factory = env.getFactory();
		String query = " WHERE " + IBOCE_LEN_RefinanceRateChangeTag.RowSeq + " BETWEEN ? AND ? ";
		ArrayList<Integer> parameters = new ArrayList<>();
		parameters.add(fromValue);
		parameters.add(toValue);
		List reFinanceTagRecords = factory.findByQuery(IBOCE_LEN_RefinanceRateChangeTag.BONAME, query,
				parameters, null);

		if (CommonUtil.checkIfNotNullOrEmpty(reFinanceTagRecords)) {
			BankFusionThreadLocal.setCurrentPageRecordIDs(reFinanceTagRecords);
			for (IBOCE_LEN_RefinanceRateChangeTag reFinanceTag : (List<IBOCE_LEN_RefinanceRateChangeTag>) reFinanceTagRecords) {
				if(!reFinanceTag.isF_IsReversed()) {
					IBOUDFEXTAttributeCollectionFeature hostExtn = (IBOUDFEXTAttributeCollectionFeature) factory.findByPrimaryKey(IBOUDFEXTAttributeCollectionFeature.BONAME, reFinanceTag.getBoID(), Boolean.TRUE);
					BigDecimal interpolatedRate = new BigDecimal(0);
					if (null!=hostExtn.getValueOfCustomField(UDF_INTERPOLATEDRATE)) {
						interpolatedRate = (BigDecimal) hostExtn.getValueOfCustomField(UDF_INTERPOLATEDRATE);
					}
					updateCreditInterestRate(reFinanceTag.getBoID(),interpolatedRate);
					
				}else {
					IBOCE_LEN_KfwRefinanceRateHistory kfwRefinanceRateHistory = (IBOCE_LEN_KfwRefinanceRateHistory) factory.findByPrimaryKey(IBOCE_LEN_KfwRefinanceRateHistory.BONAME, reFinanceTag.getBoID(), Boolean.TRUE);
					revertValueOfRateFromHistory(reFinanceTag.getBoID(),kfwRefinanceRateHistory.getF_BaseCode(), kfwRefinanceRateHistory.getF_Margin());
				}
			}
		}
		
		factory = BankFusionThreadLocal.getPersistanceFactory();
		return accumulator;
	}

	private void updateCreditInterestRate(String accountID, BigDecimal creditInterestRate) {
		IBOCreditInterestFeature iboCreditInterestFeature = (IBOCreditInterestFeature) factory
				.findByPrimaryKey(IBOCreditInterestFeature.BONAME, accountID, Boolean.TRUE);
		iboCreditInterestFeature.setF_CREDITINTERESTRATE(creditInterestRate);

		
	}

	private void revertValueOfRateFromHistory(String accountID, String baseCode, BigDecimal margin) {
		IBOCreditInterestFeature iboCreditInterestFeature = (IBOCreditInterestFeature) factory
				.findByPrimaryKey(IBOCreditInterestFeature.BONAME, accountID, Boolean.TRUE);
		iboCreditInterestFeature.setF_CREDITINTERESTRATE(new BigDecimal(0));
		iboCreditInterestFeature.setF_CREDITBASECODE(baseCode);
		iboCreditInterestFeature.setF_CREDITINTERESTMARGIN(margin);
	}

	
	
}


